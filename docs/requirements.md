# 요구사항 문서 requirements

## 만들 것
- 입력된 사주 정보를 바탕으로 사주결과 풀이를 알려주는 웹앱

## 주의사항
- clerk sdk를 이용하여 모든 인증 관련 로직, 페이지를 처리하며, **인증에는 supabase auth를 사용하지 않는다.**

- 데이터베이스는 supabase DB를 사용한다. supabase RLS는 사용하지 않는다.

- 결제는 토스 페이먼츠 sdk를 사용하여 연동한다. 

- 사주결과 풀이는 새검사에서 입력된 내용을 gemini api를 통해 검사 결과를 출력한다.

- 구독 정책
    - 무료 가입 유저는 최초 3회만 테스트 가능합니다. (`gemini-2.5-flash` 사용)
    - Pro 요금제 구독 고객은 월 10회 테스트 가능합니다. (`gemini-2.5-pro` 사용)
    - Pro 요금제 취소 시, 다음 결제일까지 구독 상태가 유지됩니다.
    - Pro 요금제 취소 시, 다음 결제일전에 취소상태를 취소할 수 있습니다.
    - 구독 해지와 동시에 빌링키를 삭제합니다. 다시 구독하려면 SDK를 통한 재발급이 필요합니다.

- 정기결제 trigger에 Supabase cron을 사용하세요.    
    작동 플로우    
    1. [Supabase cron] 매일 02:00에 trigger, **Hono 백엔드** API 호출
    2. [Next.js API (Hono)] 유효한 호출인지 검증
    3. [Next.js API (Hono)] 오늘이 결제일인 구독건들 탐색 후 하나하나 결제API 호출
        1. 결제가 성공하면 테스트 횟수 추가 + 구독 기간 연장
        2. 결제가 실패하면 즉시 구독 해지

## 페이지


### 메인 
- 서비스에 대한 설명을 표시한다.
- 시작하기를 클릭하면 대시보드로 이동한다. 로그인이 되어있지 않다면 로그인 페이지로 이동한다.

### 로그인
- clerk의 기본 제공 로그인 페이지 ui를 사용한다.

### 회원가입
- clerk의 기본 제공 회원가입 페이지 ui를 사용한다.

### 대시보드
- 왼쪽 사이드바에는 대시보드 홈버튼과 새검사 버튼이 있다. 
- 왼쪽 사이드바 하단에는 아이디와 잔여 검사 횟수, 현재 가입된 요금제가 표시된다. (잔여 횟수 및 요금제 정보는 Supabase DB에서 Clerk User ID를 기준으로 조회한다.) 클릭 시 구독관리 페이지로 이동한다.
- 대시보드 메인 컨텐츠에는 과거에 수행한 검사 결과가 표시된다.
- 메인 컨텐츠 상단에 이전에 진행했던 검사 결과를 검사자 이름을 통해 검색을 할 수 있다.
- 기존에 수행했던 검사 내역이 없을 경우, 검사 내역이 없다고 출력하고 새검사 버튼을 출력한다.
- 상단 헤더(로고, 로그인, 계정)와 푸터(회사 정보)를 통해 관련 정보를 조회할 수 있다.

### 새 검사
- 검사를 수행하기 위한 입력폼(이름, 생년월일, 출생시간, 정확한 출생시간을 모를 경우를 위한 출생시간 모름 체크박스, 성별)을 입력하고 검사 시작 버튼으로 검사를 수행한다.
- 생년월일은 캘린더 형태로 선택할 수 있다.
- 출생시간은 시계 아이콘을 클릭하면 오전, 오후를 선택하고 시, 분을 입력할 수 있다.
- 검사 시작 버튼을 누르면 사주 분석 검사를 수행하고, 검사 시작 버튼을 비활성화 하면서 로딩 메세지를 출력한다.
- 무료 회원일 경우 `gemini-2.5-flash` 사용하고, Pro 요금제 구독 고객일 경우 `gemini-2.5-pro` 사용하여 검사를 수행한다.

### 분석 모달
- gemini를 통해 출력된 요약 결과를 모달로 표시한다.
- 모달 하단의 검사 상세 보기 버튼을 클릭하면 분석 상세 페이지로 이동한다.

### 분석 상세
- 검사 결과를 모두 표시한다.

### 구독 관리
- 상단에 현재 구독 정보(요금제, 월 검사 횟수, 잔여 검사 횟수)가 표시된다. 
- 하단에 pro 요금제로 업그레이드 박스를 통해 pro 요금제 구독이 가능하다. 하단의 지금 업그레이드하기 버튼을 클릭하면 토스 페이먼츠 결제창으로 이동한다.
- pro 요금제 업그레이드 박스에는 pro 요금제 내용이 표시된다. 구독 후 환불이 불가능하다는 경고 메세지가 작게 표시된다.
- 구독해지 버튼을 클릭하면 구독을 해지한다.

### 토스 페이먼츠
- 토스 페이먼츠 기본 제공 카드 등록 페이지ui를 사용한다.
- 실제 결제가 안되는 테스트라는 경고 문구를 표시한다.