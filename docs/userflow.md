# 유저플로우 설계 문서

## 1. 인증 및 초기 설정

### [AUTH] 회원가입 및 로그인
**입력**: 회원가입/로그인 UI 완료
**처리**:
1. Clerk 인증 처리
2. 사용자 레코드 확인 및 초기 데이터 생성
3. 구독 정보 및 사용 가능 횟수 초기화
**출력**: 대시보드 이동

**엣지케이스**:
- 사용자 레코드 생성 실패 시 재시도
- 중복 가입 시도 처리

---

## 2. 대시보드 및 검사 이력

### [DASH-HOME] 대시보드 조회
**입력**: 대시보드 페이지 접근
**처리**:
1. 인증 상태 확인
2. 사용자 구독 정보 조회 (요금제, 잔여 횟수)
3. 과거 검사 이력 목록 조회
**출력**: 
- 사이드바에 사용자 정보 표시
- 검사 이력 목록 또는 빈 상태 화면

### [DASH-SEARCH] 검사 이력 검색
**입력**: 검색어 입력 및 검색 실행
**처리**:
1. 검사자 이름 기준 검색
2. 결과 필터링 및 정렬
**출력**: 검색 결과 목록

### [DASH-VIEW] 검사 결과 재조회
**입력**: 이력 목록에서 특정 검사 선택
**처리**:
1. 선택된 검사 데이터 조회
2. 사용자 권한 확인
**출력**: 분석 상세 페이지 이동

---

## 3. 사주 검사 수행

### [TEST-INPUT] 검사 정보 입력
**입력**: 새 검사 페이지 진입 및 정보 입력
- 이름, 생년월일, 출생시간, 성별
- 출생시간 모름 옵션
**처리**:
1. 인증 및 잔여 횟수 확인
2. 입력 데이터 유효성 검증
**출력**: 
- 잔여 횟수 부족 시 구독 안내
- 유효성 통과 시 검사 시작 가능

**엣지케이스**:
- 잔여 횟수 0회 시 차단
- 과거 날짜, 필수 필드 검증

### [TEST-ANALYZE] AI 분석 수행
**입력**: 검사 시작 버튼 클릭
**처리**:
1. 잔여 횟수 차감
2. 검사 레코드 생성
3. 구독 등급별 AI 모델 선택
4. AI API 호출 및 결과 저장
5. 분석 완료 상태 업데이트
**출력**:
- 로딩 상태 표시
- 성공 시 분석 모달 표시
- 실패 시 에러 메시지 및 횟수 복구

**엣지케이스**:
- API timeout 처리
- 중복 클릭 방지
- 분석 중 페이지 이탈 시 미완료 검사 정리
- 네트워크 오류 시 재시도 안내

### [TEST-MODAL] 분석 결과 모달
**입력**: 분석 완료 후 자동 표시
**처리**:
1. 요약 결과 파싱 및 포맷팅
**출력**:
- 요약 내용 표시
- 상세 보기 또는 닫기 선택

### [TEST-DETAIL] 분석 상세 조회
**입력**: 분석 상세 페이지 접근
**처리**:
1. 검사 ID로 데이터 조회
2. 사용자 권한 확인
3. 전체 분석 내용 파싱
**출력**: 전체 분석 결과 렌더링

**엣지케이스**:
- 존재하지 않는 검사 ID
- 권한 없는 사용자 접근 차단

---

## 4. 구독 관리

### [SUB-VIEW] 구독 정보 조회
**입력**: 구독 관리 페이지 접근
**처리**:
1. 현재 구독 상태 조회 (요금제, 잔여 횟수, 결제일)
2. 구독 상태별 UI 구성
**출력**:
- 무료: 업그레이드 옵션 표시
- Pro 활성: 현재 정보 및 해지 옵션
- Pro 해지 예정: 만료일 안내 및 해지 취소 옵션

### [SUB-UPGRADE] Pro 구독 신청
**입력**: 업그레이드 버튼 클릭
**처리**:
1. 현재 구독 상태 확인
2. 결제 파라미터 생성
3. 결제 SDK 호출
**출력**: 결제 페이지 이동

**엣지케이스**:
- 이미 구독 중인 경우 차단
- 결제창 이탈 시 별도 처리 없음

### [SUB-PAYMENT] 결제 완료 처리
**입력**: 결제 성공 콜백
**처리**:
1. 결제 승인 API 호출
2. 구독 정보 업데이트 (등급, 횟수, 결제일, 빌링키)
3. 트랜잭션 보장
**출력**:
- 성공: 구독 관리 페이지 이동 및 안내
- 실패: 에러 메시지 및 재시도 안내

**엣지케이스**:
- 결제 승인 실패 처리
- 중복 결제 방지

### [SUB-CANCEL] 구독 해지
**입력**: 해지 버튼 클릭
**처리**:
1. 확인 절차
2. 구독 상태를 해지 예정으로 변경
3. 빌링키 삭제
4. 다음 결제일까지 서비스 유지
**출력**: 해지 완료 안내 (만료일 표시)

### [SUB-REACTIVATE] 해지 취소
**입력**: 해지 취소 버튼 클릭 (만료일 이전)
**처리**:
1. 확인 절차
2. 구독 상태를 활성으로 복구
**출력**: 복구 완료 안내

**엣지케이스**:
- 만료일 경과 후 취소 시도 차단

---

## 5. 정기 결제 자동화

### [CRON-BILLING] 정기 결제 실행
**입력**: 스케줄러 트리거 (매일 특정 시간)
**처리**:
1. API 요청 인증 확인
2. 결제일 도래한 구독 목록 조회
3. 각 구독에 대해 결제 시도
   - 성공: 횟수 초기화 및 결제일 연장
   - 실패: 구독 해지 및 등급 다운
4. 결제 이력 기록
**출력**: 처리 결과 로그

**엣지케이스**:
- 빌링키 만료 시 구독 해지
- API timeout 시 재시도 후 실패 처리
- 중복 실행 방지

### [CRON-EXPIRE] 구독 만료 처리
**입력**: 스케줄러 트리거 (매일 특정 시간)
**처리**:
1. 해지 예정 상태에서 만료일 경과한 구독 조회
2. 등급 및 횟수 초기화
3. 구독 상태를 만료로 변경
**출력**: 처리 결과 로그

---

## 6. 시스템 관리

### [SYS-CLEANUP] 미완료 검사 정리
**입력**: 백그라운드 작업 또는 주기적 실행
**처리**:
1. 일정 시간 이상 처리 중 상태인 검사 조회
2. 검사 레코드 정리
3. 차감된 횟수 복구
**출력**: 정리 완료 로그

### [SYS-SESSION] 세션 관리
**입력**: API 요청 시 인증 오류
**처리**:
1. 세션 갱신 시도
2. 갱신 실패 시 로그아웃 처리
**출력**: 로그인 페이지 이동

---

## 기능 분류 요약

| 분류 | 플로우 | 우선순위 |
|------|--------|----------|
| 인증 | AUTH | P0 |
| 대시보드 | DASH-HOME, DASH-SEARCH, DASH-VIEW | P0 |
| 검사 수행 | TEST-INPUT, TEST-ANALYZE, TEST-MODAL, TEST-DETAIL | P0 |
| 구독 관리 | SUB-VIEW, SUB-UPGRADE, SUB-PAYMENT, SUB-CANCEL, SUB-REACTIVATE | P1 |
| 자동화 | CRON-BILLING, CRON-EXPIRE | P1 |
| 시스템 | SYS-CLEANUP, SYS-SESSION | P2 |

**다음 단계**: 각 플로우별 상세 스펙 작성 (API 엔드포인트, DB 스키마, UI 컴포넌트)